require('dotenv').config();
const { create } = require('@open-wa/wa-automate');
const axios = require('axios');

// ======================
// CONFIGURA√á√ÉO GROQ API
// ======================
const GROQ_API_KEY = process.env.GROQ_API_KEY;  // Corrigido para utilizar o nome correto da vari√°vel
const GROQ_API_URL = 'https://api.groq.com/openai/v1/chat/completions';

// ================
// GERAR RESPOSTA
// ================
async function gerarResposta(mensagem) {
  try {
    const resposta = await axios.post(
      GROQ_API_URL,
      {
        model: 'llama3-8b-8192',
        messages: [
          {
            role: 'system',
            content: 'Voc√™ √© o Bot Ytallo Shop, um assistente √∫til para responder perguntas e ajudar em vendas e d√∫vidas pelo WhatsApp.'
          },
          {
            role: 'user',
            content: mensagem
          }
        ],
        temperature: 0.7
      },
      {
        headers: {
          'Authorization': `Bearer ${GROQ_API_KEY}`, // Corrigido
          'Content-Type': 'application/json'
        }
      }
    );

    const textoGerado = resposta.data.choices?.[0]?.message?.content?.trim();
    return textoGerado || "‚ùå Desculpe, n√£o consegui gerar uma resposta.";
  } catch (err) {
    console.error('‚ùå Erro na API da Groq:', err.response?.data || err.message);
    return "‚ùå Erro ao se comunicar com a IA.";
  }
}

// ===================
// TEMPO DE EXECU√á√ÉO
// ===================
const startTime = Date.now();
function formatUptime(ms) {
  const totalSeconds = Math.floor(ms / 1000);
  const hours = Math.floor(totalSeconds / 3600);
  const minutes = Math.floor((totalSeconds % 3600) / 60);
  const seconds = totalSeconds % 60;
  return `${hours}h ${minutes}m ${seconds}s`;
}

let clientInstance = null;

create({
  useChrome: true,
  executablePath: 'C:\\Program Files\\Google\\Chrome\\Application\\chrome.exe',
  headless: false
}).then(client => {
  start(client);
});

async function start(client) {
  console.log('‚úÖ Bot conectado no WhatsApp com sucesso!');
  clientInstance = client;

  client.onMessage(async (message) => {
    try {
      const { body, from, isGroupMsg, chat, sender, mentionedJidList } = message;
      const command = body.toLowerCase();
      const groupId = chat?.groupMetadata?.id;
      const senderId = sender.id;
      const isGroupAdmin = chat?.groupMetadata?.participants.find(p => p.id === senderId)?.isAdmin;
      const botNumber = await client.getHostNumber() + "@c.us";
      const isBotAdmin = chat?.groupMetadata?.participants.find(p => p.id === botNumber)?.isAdmin;

      if (isGroupMsg && (body.includes("http://") || body.includes("https://"))) {
        if (!isGroupAdmin) {
          await client.sendText(from, `üö´ ${sender.pushname} voc√™ n√£o pode mandar links aqui!`);
          await client.removeParticipant(groupId, senderId);
          console.log(`üö´ Removido ${sender.pushname} por enviar link.`);
          return;
        }
      }

      if (command.startsWith('!')) {
        console.log(`üì© Comando recebido: ${command}`);

        if (command === '!ping') {
          const uptime = formatUptime(Date.now() - startTime);
          const speed = Date.now() - message.t;
          await client.sendText(from, `üèì *Pong!*\n\nTempo online: ${uptime}\nVelocidade: ${speed}ms`);
        }

        else if (command === '!anuncio1') {
          await client.sendText(from, `‚öúÔ∏è Ytallo Shop ‚öúÔ∏è
        
        Contato PV: https://wa.me/qr/RLNHS7S3UGOKE1
        
        *RAPAZIADA, NOVOS PRODUTOS AI PRA VOC√äS*
        
        Se liga nos produtos que podem mudar seu jogo ‚Äî seja pra ganhar mais, se proteger na net ou s√≥ curtir com estilo!
        
        Chama no PV pra manter a privacidade de cada um. Atendimento r√°pido e sigiloso!
        
        üé¨ Filmes e S√©ries em Alta Qualidade ‚Äì Lan√ßamentos e cl√°ssicos em qualidade m√°xima, vital√≠cio.
        R$19,99
        
        üéØ Xits de Free Fire ‚Äì CLT, FOCCUS, anti-ban, configs tops pra subir capa f√°cil.
        R$24,99
        
        üöÄ Apps Unlocked ‚Äì YouTube Vanced, Revanced, Spotify MOD e outros apps desbloqueados.
        R$9,99
        
        üóÑÔ∏è Servidores Remotos Sem Rastreio ‚Äì Armazenamento seguro, criptografado, de 10GB a 1PTB.
        R$34,99
        
        üõ°Ô∏è VPN Privada ‚Äì Prote√ß√£o total e navega√ß√£o an√¥nima, com IP dedicado e alta velocidade.
        R$22,99
        
        ü§ñ Chatbot Personalizado ‚Äì Chat autom√°tico no WhatsApp, Telegram ou site, com comandos edit√°veis.
        R$39,99
        
        üåê Cria√ß√£o de Sites & Landing Pages ‚Äì P√°gina profissional pronta pra vender, responsiva e r√°pida.
        R$59,99
        
        ‚öôÔ∏è Ferramentas Digitais ‚Äì Bots, scripts e automatiza√ß√µes pra facilitar sua vida.
        R$24,99
        
        üéÆ Contas Premium ‚Äì Netflix, Spotify, Crunchyroll, Amazon e mais. (Perfil compartilhado 1 m√™s)
        R$14,99
        
        üì≤ Clonagem de Sites ‚Äì Replica exata de qualquer site ou loja virtual, pronta pra uso.
        R$49,99
        
        üîê Prote√ß√£o Total de Dados ‚Äì Configura√ß√µes exclusivas pra garantir anonimato e seguran√ßa real.
        R$19,99
        
        üß∞ Edi√ß√£o e Design em APK ‚Äì CapCut PRO, VN, InShot PRO e outros apps premium desbloqueados.
        R$12,99
        
        üíΩ Hospedagem + Dom√≠nio ‚Äì Hospedagem + dom√≠nio .com por 1 ano incluso.
        R$49,99
        
        üì∏ Edi√ß√£o de IMG e Remo√ß√£o de marca d'√°gua 
        
        Edi√ß√£o de imagem:
        1 unidade - R$15
        
        Remo√ß√£o de marca d'√°gua:
        
        Foto:
        1 unidade - R$13
        
        V√≠deos:
        1 unidade - R$36
        
        Todos os servi√ßos com garantia e suporte! Chama no PV e garanta o seu!`);
        }
        


        else if (command === '!anuncio2') {
          await client.sendText(from, `*‚öúÔ∏è Ytallo Shop ‚öúÔ∏è*

Contato PV:  https://wa.me/qr/RLNHS7S3UGOKE1

RAPAZIADA, NOVOS PRODUTOS AI PRA VOC√äS

üîéPAIN√âIS DE CONSULTAüîé

CPF, EMAIL, CNPJ E TELEFONE

üìå HARD BUSCA
30 DIAS - R$ 120,00
15 DIAS - R$ 100,00
7 DIAS - R$ 50,00

Valor Unit√°rio:

CPF - 25$
EMAIL - 20$
CNPJ - 30$
TELEFONE - 20$

ü™™ CPF E CNPJ FALSIFICADOS

Planos Ilimitados:
30 DIAS - 130$
15 DIAS - 90$
7 DIAS - 50$
Valor Unit√°rio:
 CPF - 25$
 CNPJ - 30$

üìû SPAM

PLANO ILIMITADO:
30 DIAS - 120$
15 DIAS - 70$
7 DIAS - 30$

Unitario:
SPAM UNI - 10$

‚úâÔ∏è E-MAIL VIRGEM

VALOR UNITARIO:
1 E-MAIL - 10$

üì±APPS LARA

Valores Unit√°rios:
1 Banco Lara - 20$

üåêTelas FK

Valor Unit√°rio:
1 Tela - 20$

üìöE-BOOK PLR'S

Valor em grupos de e-book:

100 - 30$
700 - 100$

ü§ñMetodos de IA

VALOR UNIT√ÅRIO:

CHATGPT - 30$
DETECTOR DE VOZ - 40$
CONSTRUTOR DE SITES - 60$
CONVERSA COM CLIENTES - 40$

BORA RAPAZIADA, NOVOS PRODUTOS COMPLETO`);
        }
        
        else if (command === '!anuncio3') {
          await client.sendText(from, `*‚öúÔ∏è Ytallo Shop ‚öúÔ∏è*

Contato PV:  https://wa.me/qr/RLNHS7S3UGOKE1


*Quer dar Aquele golpe em velhos ou pessoas desinformadas vendendo produtos falso pra lucrar? Trouxe a solu√ß√£o: Telas Fake e Gatway Privado com suporte 24hrs para d√∫vidas e ajudas*

- *Tela Fake:*
-  Marcado Livre 5 produtos 50$, 10 produtos 100$ e etc. (com Gatway Funcionando).
- Netflix com 3 planos mensais 60$ (com Gatway Funcionando).
- Shoppe 5 produtos 50$, 10 produto 100$ (gatway Funcionando).


- *Gatway:*
- somente o sistema de pagamento para adaptar ao c√≥digo front 70$.
- site criado do zero com o gatway pronto e funcionando 120$`);
        }

        else if (command === '!anuncio4') {
          await client.sendText(from, `*‚öúÔ∏è Ytallo Shop ‚öúÔ∏è*

*PROMO√á√ÉO DE RG:*

Contato PV:  https://wa.me/qr/RLNHS7S3UGOKE1

_Quer uma RG com todos os dados Completo?, com a RG virtual verdadeira e funcional, com marca d'√°gua do governo do pa√≠s e do estado pronto pra ir para a sua mao, aqui funciona assim: compra recebe o produto a√≠ e s√≥ usar e ser feliz, vem pegar a tua!_

Enteressados Chamem o Meu PV, N√£o chame se n√£o Estiver Interessado para n√£o me Atrasar

*Interessados, Valor:* _40$_, *OBS:*_RG virtual, fica em seu crit√©rio a impress√£o dela_

`);
} else {
  await client.sendText(from, '‚ùå An√∫ncio inv√°lido. Use de 1 a 5.');
};
}

        else if (command === '!anuncio5') {
          await client.sendText(from, 'rg-falso.jpeg', // Caminho local ou URL direta
              `*‚öúÔ∏è Ytallo Shop ‚öúÔ∏è*
        
        *PROMO√á√ÉO DE RG:*
        
        Contato PV:  https://wa.me/qr/RLNHS7S3UGOKE1
        
        _Quer uma RG com todos os dados Completo?, com a RG virtual verdadeira e funcional, com marca d'√°gua do governo do pa√≠s e do estado pronto pra ir para a sua mao, aqui funciona assim: compra recebe o produto a√≠ e s√≥ usar e ser feliz, vem pegar a tua!_
        
        Enteressados Chamem o Meu PV, N√£o chame se n√£o Estiver Interessado para n√£o me Atrasar
        
        *Interessados, Valor:* _40$_, *OBS:*_RG virtual, fica em seu crit√©rio a impress√£o dela_`
            );
          } else {
            await client.sendText(from, '‚ùå An√∫ncio inv√°lido. Use de 1 a 5.');
          };
        
        else if (command.startsWith('!ban')) {
          if (!isGroupMsg) return await client.sendText(from, '‚ùå Este comando s√≥ pode ser usado em grupos.');
          if (!isGroupAdmin) return await client.sendText(from, '‚ùå Somente administradores podem usar esse comando.');
          if (!mentionedJidList.length) return await client.sendText(from, '‚ùå Voc√™ precisa marcar a pessoa que quer banir.');
          if (!isBotAdmin) return await client.sendText(from, '‚ùå Preciso ser administrador para banir algu√©m.');

          for (let user of mentionedJidList) {
            await client.removeParticipant(groupId, user);
          }
          await client.sendText(from, 'üëã Participante removido com sucesso!');
        }

        else if (command.startsWith('!add')) {
          if (!isGroupMsg) return await client.sendText(from, '‚ùå Este comando s√≥ pode ser usado em grupos.');
          if (!isGroupAdmin) return await client.sendText(from, '‚ùå Somente administradores podem usar esse comando.');
          if (!isBotAdmin) return await client.sendText(from, '‚ùå Preciso ser administrador para adicionar pessoas.');

          const number = body.split(' ')[1];
          if (!number) return await client.sendText(from, '‚ùå Voc√™ precisa informar o n√∫mero. Exemplo: !add 5581999999999');

          await client.addParticipant(groupId, number + '@c.us');
          await client.sendText(from, '‚úÖ Usu√°rio adicionado com sucesso!');
        }

        else if (command === '!menu') {
                              const menuMessage = `
üìã *Menu - Bot Ytallo Shop*

*Sistema:*
‚Ä¢ !ping - Verifica a conectividade do bot

*Administrativo:*
‚Ä¢ !add +55 - Adiciona um n√∫mero ao grupo
‚Ä¢ !ban @usuario - Remove um usu√°rio

*Pesquisas:*
‚Ä¢ S√≥ fa√ßa as perguntas que ele ir√° responder corretamente

Envie sua d√∫vida ou mensagem para receber uma resposta autom√°tica!
          `;
          await client.sendText(from, menuMessage);
        }

        else {
          await client.sendText(from, '‚ùå Comando n√£o reconhecido.');
        }
      }

      else {
        const resposta = await gerarResposta(body);
        await client.sendText(from, resposta);
        console.log('‚úÖ Respondeu com Groq:', resposta);
      }

    } catch (err) {
      console.error('‚ùå Erro ao processar a mensagem:', err);
    }
  };
};

function startBot(io) {
  console.log('üöÄ Iniciando bot via interface...');
  return create({ sessionId: "BOT", multiDevice: true, authTimeout: 60, blockCrashLogs: true, disableSpins: true, headless: true, qrTimeout: 0 })
    .then(client => {
      start(client);
      io.emit('botStatus', 'Bot iniciado com sucesso!');
    })
    .catch(err => {
      console.error('‚ùå Erro ao iniciar bot:', err);
      io.emit('botStatus', 'Erro ao iniciar bot.');
    });
}

function stopBot() {
  if (clientInstance) {
    console.log('üõë Parando bot...');
    clientInstance.close();
    clientInstance = null;
  }
}

function getBotStatus() {
  return clientInstance ? 'Rodando' : 'Parado';
}

module.exports = { startBot, stopBot, getBotStatus };
